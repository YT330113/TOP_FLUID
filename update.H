/********************************************************************/
/*************************设计变量更新及求解场输出*****************/
/********************************************************************/

opt++; // 迭代次数增加

Info << "\nIter:  " << opt << nl <<endl;

/************************计算结果输出*****************************/

if(solid_area)
{
    forAll(cells_solid, i)
    {
        xh[cells_solid[i]] = 0; //对非设计域单元将设计变量置1,注意这里是对xh的，creatfields.H是对x的
    }
}
if(fluid_area)
{
   forAll(cells_fluid, i)
   {
      xh[cells_fluid[i]]=1.0;
   }
}
xh.correctBoundaryConditions();
//由于边界上的值是通过边界条件的类型从面相邻单元的内部场数据计算的来的，当内部场改变时，边界的值就需要从新计算

if(runTime.writeTime())
{
   xh.write();
   U.write();
   Ua.write();
}
//---------------------------------------------------------------------------------------------//

/****************流体问题一些参数的放松，防止初始约束过强导致仅优化出一根简单的管道*************/

//alphaMax先线性增长，再指数增长
if(opt<=45)//45,95,145                                                                    // 最大流组系数随着迭代次数逐渐增大
{
  alphaMax=alphamax*(opt/7.0+1.0);
}
else
{
    alphaMax = alphaMax * 1.05;
    qu = 0.01 + (opt - 63) * 1e-4;                                                    // 流阻系数插值模型中的q_alpha随迭代次数逐渐增大,初始为0.1  
}
alphaMax.value() = Foam::min(alphaMax.value(), alphaMAX.value());                            // alphaMax的最大值是alphaMAX
qu=Foam::min(qu,0.02);

/***************************************材料参数更新*********************************/

alpha=alphaMax*qu*(1-xh)/(qu+xh); // 体标量场流阻系数插值更新,可以看出，xh参与下一次迭代中物理场的求解
//-----------------------------------------------------------------------------------------------------------------//
